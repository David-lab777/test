<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>付款处理中...</title>
</head>
<body>
    <script>
        // 固定参数
        const FIXED_APP_ID = 'wxad94e9ad4d1e3555';
        const FIXED_MCH_ID = '1104737397';
        
        // 从URL获取package参数
        const getUrlParam = (name) => {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        };
        
        const packageStr = getUrlParam('p');
        
        if (!packageStr) {
            
           window.location.href = "https://www.baidu.com";
            //document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;">错误：缺少package参数(p)</div>';
            //throw new Error('缺少package参数(p)');
        }
        
        // 解码package参数
        let decodedPackage = packageStr;
        try {
            // 尝试解码
            decodedPackage = decodeURIComponent(packageStr);
        } catch (e) {
            console.log('无需解码或解码失败，使用原字符串');
        }
        
        console.log('支付参数:', {
            appId: FIXED_APP_ID,
            mchId: FIXED_MCH_ID,
            package: decodedPackage
        });
        
        // 主要支付逻辑
        const initiatePayment = () => {
            // 检查是否在微信环境中
            const isWeixin = /MicroMessenger/i.test(navigator.userAgent);
            
            if (!isWeixin) {
                 window.location.href = "https://www.baidu.com";
               /* document.body.innerHTML = `
                    <div style="text-align:center;padding:50px;">
                      <h3>请在微信中打开此页面</h3>
                        <p>检测到当前不在微信环境中</p>
                        <p>请复制链接到微信中打开</p>
                    </div>
                `;*/
                return;
            }
            
            // 在微信环境中，尝试调用支付
            if (typeof WeixinJSBridge !== 'undefined') {
                console.log('检测到WeixinJSBridge，发起付款...');
                
                document.body.innerHTML = '<div style="text-align:center;padding:50px;">正在发起付款...</div>';
                
                WeixinJSBridge.invoke(
                    'requestMerchantTransfer',
                    {
                        mchId: FIXED_MCH_ID,
                        appId: FIXED_APP_ID,
                        package: decodedPackage
                    },
                    function(res) {
                        console.log('支付结果:', res);
                        
                        let message = '处理中...';
                        
                        if (res.err_msg === 'requestMerchantTransfer:ok') {
                            message = '付款请求已提交成功';
                        } else if (res.err_msg === 'requestMerchantTransfer:cancel') {
                            message = '付款已取消';
                        } else if (res.err_msg && res.err_msg.includes('fail')) {
                            message = '付款失败: ' + res.err_msg;
                        } else {
                            message = '处理结果: 未知状态';
                        }
                       window.location.href = "https://www.baidu.com";
                        document.body.innerHTML = `
                            <div style="text-align:center;padding:50px;">
                                <h3>${message}</h3>
                                <p id="countdown">请手动关闭页面</p>
                            </div>
                        `;
                   
                    }
                );
            } else {
                // 等待WeixinJSBridge就绪
                document.body.innerHTML = '<div style="text-align:center;padding:50px;">正在加载支付组件...</div>';
                
                if (document.addEventListener) {
                    document.addEventListener('WeixinJSBridgeReady', function() {
                        if (typeof WeixinJSBridge !== 'undefined') {
                            initiatePayment(); // 重新执行
                        }
                    }, false);
                }
                
                // 5秒后如果还没加载出来，显示提示
                setTimeout(() => {
                    if (typeof WeixinJSBridge === 'undefined') {
                        document.body.innerHTML = `
                            <div style="text-align:center;padding:50px;">
                                <h3>支付组件加载失败</h3>
                                <p>请尝试：</p>
                                <p>1. 刷新页面重试</p>
                                <p>2. 检查微信版本是否为最新</p>
                                <p>3. 联系客服处理</p>
                            </div>
                        `;
                    }
                }, 5000);
            }
        };
        
        // 页面加载完成后开始支付流程
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initiatePayment);
        } else {
            initiatePayment();
        }
    </script>
</body>
</html>
